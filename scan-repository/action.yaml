name: 'Scan Repository'
description: 'Scan repository for vulnerabilities'
inputs:
  report-path:
    description: 'Output file name'
    required: false
    default: 'trivy-repository.report'
  report-format:
    description: 'Report format (sarif, json, table)'
    required: false
    default: 'table'
  severity:
    description: 'Severity level (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)'
    required: false
    default: 'CRITICAL,HIGH'
  fail-on-vulns:
    description: 'Fail build on found vulnerabilities'
    required: false
    default: 'false'

runs:
  using: "composite"
  steps:
    - name: Generate Trivy Vulnerability Report
      uses: aquasecurity/trivy-action@0.29.0
      with:
        scan-type: "fs"
        output: ${{ inputs.report-path }}
        format: ${{ inputs.report-format }}
        scan-ref: .
        exit-code: 0

    - name: Upload Vulnerability Scan Results
      uses: actions/upload-artifact@v4
      with:
        name: trivy-repository
        path: $${{ inputs.report-path }}
        retention-days: 30

    - name: Fail build on Found Vulnerabilities
      if: ${{ inputs.fail-on-vulns == 'true' }}
      uses: aquasecurity/trivy-action@0.29.0
      with:
        scan-type: "fs"
        format: table
        scan-ref: .
        severity: ${{ inputs.severity }}
        ignore-unfixed: true
        exit-code: 1
        # On a subsequent call to the action we know trivy is already installed so can skip this
        skip-setup-trivy: true